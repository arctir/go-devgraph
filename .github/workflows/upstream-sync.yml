name: Sync from Upstream Spec

on:
  repository_dispatch:
    types: [upstream_spec_update]
  workflow_dispatch:  # Allow manual triggers

jobs:
  regenerate-client:
    name: Regenerate Go Client from Upstream
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Fetch latest API spec from devgraph repo
      run: |
        echo "ðŸ“¥ Fetching spec from devgraph repository..."
        mkdir -p ../devgraph/specs/devgraph/v1
        curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.raw" \
          -o ../devgraph/specs/devgraph/v1/spec.yaml \
          https://api.github.com/repos/arctir/devgraph/contents/specs/devgraph/v1/spec.yaml?ref=main

        echo "âœ… Spec downloaded successfully"
        ls -lh ../devgraph/specs/devgraph/v1/spec.yaml

    - name: Install ogen
      run: go install -v github.com/ogen-go/ogen/cmd/ogen@latest

    - name: Generate Go client code
      run: |
        echo "ðŸ”¨ Generating Go client from OpenAPI spec..."
        make generate
        echo "âœ… Client generation complete"

    - name: Run go mod tidy
      run: |
        echo "ðŸ“¦ Running go mod tidy..."
        go mod tidy
        echo "âœ… Dependencies updated"

    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        go test ./... || echo "âš ï¸  Tests failed, but continuing with PR creation"

    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸  No changes detected"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "âœ… Changes detected:"
          git diff --stat
        fi

    - name: Create Pull Request
      if: steps.check_changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: regenerate Go client from upstream spec update"
        title: "ðŸ¤– Regenerate Go client from upstream spec update"
        body: |
          ## Automated Client Regeneration

          This PR was automatically generated in response to an upstream API specification update.

          ### Details
          - **Source**: devgraph repository
          - **Trigger**: Upstream spec update
          - **Commit**: ${{ github.event.client_payload.ref }}
          - **Generated by**: GitHub Actions workflow

          ### Changes
          - Regenerated Go client code from latest OpenAPI specification
          - Updated dependencies with `go mod tidy`

          ### Review Checklist
          - [ ] Review generated code changes
          - [ ] Verify tests pass
          - [ ] Check for breaking changes in the API
          - [ ] Update any example code if needed

          ---
          ðŸ¤– *This is an automated pull request. Please review carefully before merging.*
        branch: upstream-spec-sync
        delete-branch: true
        labels: |
          automated
          upstream-sync
          client-generation

    - name: Summary
      if: steps.check_changes.outputs.changes == 'false'
      run: |
        echo "### â„¹ï¸  No Changes Needed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The generated client code is already up-to-date with the upstream specification." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Upstream commit**: ${{ github.event.client_payload.ref }}" >> $GITHUB_STEP_SUMMARY
