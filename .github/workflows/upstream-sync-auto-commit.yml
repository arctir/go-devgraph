name: Sync from Upstream Spec (Auto-commit)

on:
  repository_dispatch:
    types: [upstream_spec_update]
  workflow_dispatch:  # Allow manual triggers

jobs:
  regenerate-client:
    name: Regenerate and Auto-commit Go Client
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Fetch latest API spec from devgraph repo
      run: |
        echo "ðŸ“¥ Fetching spec from devgraph repository..."
        mkdir -p ../devgraph/specs/devgraph/v1
        curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.raw" \
          -o ../devgraph/specs/devgraph/v1/spec.yaml \
          https://api.github.com/repos/arctir/devgraph/contents/specs/devgraph/v1/spec.yaml?ref=main

        echo "âœ… Spec downloaded successfully"
        ls -lh ../devgraph/specs/devgraph/v1/spec.yaml

    - name: Install ogen
      run: go install -v github.com/ogen-go/ogen/cmd/ogen@latest

    - name: Generate Go client code
      run: |
        echo "ðŸ”¨ Generating Go client from OpenAPI spec..."
        make generate
        echo "âœ… Client generation complete"

    - name: Run go mod tidy
      run: |
        echo "ðŸ“¦ Running go mod tidy..."
        go mod tidy
        echo "âœ… Dependencies updated"

    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        if go test ./...; then
          echo "âœ… All tests passed"
        else
          echo "âŒ Tests failed!"
          exit 1
        fi

    - name: Check for changes and commit
      run: |
        if git diff --quiet; then
          echo "â„¹ï¸  No changes detected - client is already up-to-date"
          echo "### â„¹ï¸  No Changes Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The generated client code is already up-to-date with the upstream specification." >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… Changes detected, committing..."
          git add .
          git commit -m "chore: regenerate Go client from upstream spec update

Automated commit triggered by upstream spec update from devgraph repository.

Source commit: ${{ github.event.client_payload.ref }}
Triggered by: GitHub Actions upstream-sync workflow"

          git push origin main

          echo "### âœ… Client Updated Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Go client has been regenerated and committed to main." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream commit**: ${{ github.event.client_payload.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes**:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git show --stat HEAD >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
